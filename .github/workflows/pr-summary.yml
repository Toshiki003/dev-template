name: PR Summary (Optional)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-summary:
    runs-on: ubuntu-latest
    if: ${{ vars.AI_ENABLED == 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD -- . ':!*.lock' ':!package-lock.json' | head -c 10000)
          echo "diff<<DIFF_EOF" >> "$GITHUB_OUTPUT"
          echo "$DIFF" >> "$GITHUB_OUTPUT"
          echo "DIFF_EOF" >> "$GITHUB_OUTPUT"

      - name: Generate summary with OpenAI API
        if: ${{ secrets.OPENAI_API_KEY != '' }}
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const resp = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
              },
              body: JSON.stringify({
                model: 'gpt-4o-mini',
                messages: [
                  {
                    role: 'system',
                    content: 'You are a strict senior reviewer. Summarize the PR changes in Japanese for a GitHub PR description. Include: what changed, why, risk/impact, how to test, and security considerations. Keep it concise.'
                  },
                  {
                    role: 'user',
                    content: `PR Title: ${process.env.PR_TITLE}\n\nDiff:\n${process.env.PR_DIFF}`
                  }
                ],
                max_tokens: 1024,
              }),
            });

            const data = await resp.json();
            if (!resp.ok) {
              core.warning(`OpenAI API error: ${JSON.stringify(data)}`);
              return;
            }

            const summary = data.choices[0].message.content;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## AI PR Summary\n\n${summary}\n\n---\n*Generated by OpenAI API*`,
            });
