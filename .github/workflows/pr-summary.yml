name: PR Summary (Optional)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-summary:
    runs-on: ubuntu-latest
    if: ${{ vars.AI_ENABLED == 'true' }}
    env:
      LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD -- . ':!*.lock' ':!package-lock.json' | head -c 10000)
          echo "diff<<DIFF_EOF" >> "$GITHUB_OUTPUT"
          echo "$DIFF" >> "$GITHUB_OUTPUT"
          echo "DIFF_EOF" >> "$GITHUB_OUTPUT"

      - name: Generate summary with LLM API
        if: ${{ env.LLM_API_KEY != '' }}
        uses: actions/github-script@v7
        env:
          LLM_API_BASE: ${{ vars.LLM_API_BASE || 'https://generativelanguage.googleapis.com/v1beta/openai' }}
          LLM_MODEL: ${{ vars.LLM_MODEL || 'gemini-2.5-flash' }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const apiBase = process.env.LLM_API_BASE;
            const model = process.env.LLM_MODEL;

            const resp = await fetch(`${apiBase}/chat/completions`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${process.env.LLM_API_KEY}`,
              },
              body: JSON.stringify({
                model: model,
                messages: [
                  {
                    role: 'system',
                    content: 'You are a strict senior reviewer. Summarize the PR changes in Japanese for a GitHub PR description. Include: what changed, why, risk/impact, how to test, and security considerations. Keep it concise.'
                  },
                  {
                    role: 'user',
                    content: `PR Title: ${process.env.PR_TITLE}\n\nDiff:\n${process.env.PR_DIFF}`
                  }
                ],
                max_tokens: 1024,
              }),
            });

            const data = await resp.json();
            if (!resp.ok) {
              core.warning(`LLM API error: ${JSON.stringify(data)}`);
              return;
            }

            // Detect provider name from API base URL
            let provider = 'LLM API';
            if (apiBase.includes('generativelanguage.googleapis.com')) {
              provider = 'Gemini';
            } else if (apiBase.includes('api.openai.com')) {
              provider = 'OpenAI';
            } else if (apiBase.includes('api.anthropic.com')) {
              provider = 'Anthropic';
            }

            const summary = data.choices[0].message.content;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## AI PR Summary\n\n${summary}\n\n---\n*Generated by ${provider} (${model})*`,
            });
