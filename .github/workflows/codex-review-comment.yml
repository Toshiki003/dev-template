name: Codex Review & Summary (Optional)

on:
  pull_request:
    types: [labeled, synchronize]

permissions:
  pull-requests: write

jobs:
  comment:
    runs-on: ubuntu-latest
    if: ${{ vars.AI_ENABLED == 'true' }}
    steps:
      - name: Comment @codex review when ai-review label is present
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.REVIEW_PAT || github.token }}
          script: |
            const action = context.payload.action;

            if (action === "labeled") {
              // labeled イベント: 付与されたラベルが ai-review か確認
              const label = context.payload.label?.name;
              if (label !== "ai-review") {
                core.info(`Label "${label}" is not ai-review. Skipping.`);
                return;
              }
            } else if (action === "synchronize") {
              // synchronize イベント: PRに ai-review ラベルが付いているか確認
              const labels = await github.paginate(github.rest.issues.listLabelsOnIssue, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                per_page: 100,
              });
              if (!labels.some(l => l.name === "ai-review")) {
                core.info("ai-review label not present. Skipping.");
                return;
              }
            }

            const marker = "<!-- codex-review-request -->";
            const body = [
              marker,
              "@codex review",
              "",
              "まず「## AI PR Summary」セクションとして、変更内容の要約を日本語で記載してください。",
              "含める項目: 何が変わったか、なぜ、リスク・影響、テスト方法、セキュリティ考慮事項",
              "",
              "その後、以下の重点でレビューしてください:",
              "セキュリティ / 運用 / 可観測性 / 壊れやすい境界条件"
            ].join("\n");

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;

            // 既存のトリガーコメントを削除（スレッドの肥大化を防止）
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner, repo, issue_number, per_page: 100,
            });
            const existing = comments.find(c => typeof c.body === "string" && c.body.includes(marker));
            if (existing) {
              await github.rest.issues.deleteComment({ owner, repo, comment_id: existing.id });
              core.info(`Deleted previous trigger comment: ${existing.id}`);
            }

            // 新規コメントを作成（Codexに新着メンションとして認識させる）
            const created = await github.rest.issues.createComment({
              owner, repo, issue_number, body,
            });
            core.info(`Created review request comment: ${created.data.id}`);
