name: Codex Review & Summary (Optional)

on:
  pull_request:
    types: [labeled, synchronize]

permissions:
  pull-requests: write

jobs:
  comment:
    runs-on: ubuntu-latest
    if: ${{ vars.AI_ENABLED == 'true' }}
    steps:
      - name: Comment @codex review when ai-review label is present
        uses: actions/github-script@v8
        with:
          script: |
            const action = context.payload.action;

            if (action === "labeled") {
              // labeled イベント: 付与されたラベルが ai-review か確認
              const label = context.payload.label?.name;
              if (label !== "ai-review") {
                core.info(`Label "${label}" is not ai-review. Skipping.`);
                return;
              }
            } else if (action === "synchronize") {
              // synchronize イベント: PRに ai-review ラベルが付いているか確認
              const { data: labels } = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              if (!labels.some(l => l.name === "ai-review")) {
                core.info("ai-review label not present. Skipping.");
                return;
              }
            }

            const body = [
              "@codex review",
              "",
              "まず「## AI PR Summary」セクションとして、変更内容の要約を日本語で記載してください。",
              "含める項目: 何が変わったか、なぜ、リスク・影響、テスト方法、セキュリティ考慮事項",
              "",
              "その後、以下の重点でレビューしてください:",
              "セキュリティ / 運用 / 可観測性 / 壊れやすい境界条件"
            ].join("\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
